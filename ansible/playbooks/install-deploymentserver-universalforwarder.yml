---
#######################################################################################################################
# EXAMPLE DEPLOYMENT SERVER AND UNIVERSAL FORWARDER DEPLOYMENT
#######################################################################################################################
- hosts: local
  vars_files:
    - ../vars/default-standalone.yml 
  tasks:
    # download splunk enterprise and uf to /tmp/splunk.rpm and /tmp/splunkuf.rpm
    - name: Download Splunk
      include_role:
        name: download_splunk

#######################################################################################################################
# INSTALL DEPLOYMENT SERVER
#######################################################################################################################

- hosts: splunk_deployment_server
  vars_files:
    - ../vars/default-standalone.yml
  gather_facts: True
  pre_tasks:
    - name: Include Deployment Server Variable
      include_vars: ../vars/splunk_deployment_server.yml
    
    - name: Include Deployment Client Variable
      include_vars: ../vars/splunk_deployment_client.yml

    # PRE CONFIG - Add users
    - name: Custom splunk server pre-config (setup user)
      include_role:
        name: pre_config
  
  post_tasks:
    # Set ulimits by service (assumes systemd service deployment)
    - name: Post install config
      import_tasks: ../roles/post_config/tasks/main.yml
      
  tasks:

    # DEPLOYMENTSERVER - check for splunk_deployment_server role
    - name: Splunk splunk_deployment_server tasks
      include_role:
        name: splunk_deployment_server
      when: inventory_hostname in groups['splunk_deployment_server']

    # UNIVERSAL FORWARDER - check for splunk_universal_forwarder role
    - name: Splunk splunk_universal_forwarder tasks
      include_role:
        name: splunk_universal_forwarder
      when: inventory_hostname in groups['splunk_universal_forwarder']
 
      
#######################################################################################################################
# INSTALL UNIVERSAL FORWARDER
#######################################################################################################################

- hosts: splunk_universal_forwarder
  vars_files:
    - ../vars/default-standalone.yml
  gather_facts: True
  pre_tasks:
    - name: Include Deployment Server Variable
      include_vars: ../vars/splunk_deployment_server.yml
    
    - name: Include Deployment Client Variable
      include_vars: ../vars/splunk_deployment_client.yml

    # PRE CONFIG - Add users
    - name: Custom splunk server pre-config (setup user)
      include_role:
        name: pre_config

    #########################################
    # VARIABLES DEFINING UNIVERSAL FORWARDER CONFIG
    ##########################################

    # Set universal_forwarder
    - name: Include Universal Forwarder Variable
      include_vars: ../vars/splunk_universal_forwarder.yml
      when: 
        - splunk_enable_universal_forwarder 
        - inventory_hostname in groups['splunk_universal_forwarder']
  post_tasks:
    # Set ulimits by service (assumes systemd service deployment)
    - name: Post install config
      import_tasks: ../roles/post_config/tasks/main.yml
        
  tasks:

    # UNIVERSAL FORWARDER - check for splunk_universal_forwarder role
    - name: Splunk splunk_universal_forwarder tasks
      include_role:
        name: splunk_universal_forwarder
      when: inventory_hostname in groups['splunk_universal_forwarder']